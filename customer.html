<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - Vuma Lockers</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Customer Specific Styles */
        .customer-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .pickup-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .parcel-info {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .otp-input-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .otp-inputs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .otp-digit {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .otp-digit:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .pickup-history {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .history-table th, .history-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-picked {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .btn-pickup {
            background: #28a745;
            color: white;
            font-size: 18px;
            padding: 15px;
        }
        
        .btn-pickup:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .instruction-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .success-animation {
            text-align: center;
            padding: 20px;
        }
        
        .locker-opening {
            font-size: 48px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="customer-header">
            <h1>Welcome to Vuma Lockers! üëã</h1>
            <p>Collect your parcel using the OTP sent to your phone</p>
            <div style="margin-top: 10px;">
                <a href="login.html" class="btn btn-secondary">üö™ Logout</a>
            </div>
        </div>

        <!-- Current Parcel Section -->
        <div class="pickup-section">
            <h2>üì¶ Your Parcel</h2>
            
            <!-- Parcel Information -->
            <div class="parcel-info" id="parcelInfo">
                <h3>Parcel Ready for Pickup</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div>
                        <strong>Locker Number:</strong><br>
                        <span id="lockerNumber" style="font-size: 18px; color: #2980b9;">LKR-M02</span>
                    </div>
                    <div>
                        <strong>Received:</strong><br>
                        <span id="receivedTime">Today, 10:30 AM</span>
                    </div>
                    <div>
                        <strong>Sender:</strong><br>
                        <span id="senderInfo">Jumia Kenya</span>
                    </div>
                    <div>
                        <strong>Status:</strong><br>
                        <span class="status-badge status-ready" id="parcelStatus">Ready for Pickup</span>
                    </div>
                </div>
            </div>

            <!-- OTP Input Section -->
            <div class="otp-input-section">
                <h3>üîê Enter Your OTP Code</h3>
                <p>Enter the 6-digit code sent to your phone via SMS</p>
                
                <div class="instruction-box">
                    üí° <strong>How to collect:</strong><br>
                    1. Enter the 6-digit OTP code below<br>
                    2. Click "Open Locker & Collect Parcel"<br>
                    3. Your assigned locker will open automatically<br>
                    4. Collect your parcel and close the locker door
                </div>

                <!-- OTP Input Boxes -->
                <div class="otp-inputs">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 1)">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 2)">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 3)">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 4)">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 5)">
                    <input type="text" class="otp-digit" maxlength="1" oninput="moveToNext(this, 6)">
                </div>

                <!-- OTP Timer -->
                <div style="margin: 15px 0;">
                    ‚è∞ OTP expires in: <span id="otpTimer" style="font-weight: bold; color: #e74c3c;">09:45</span>
                </div>

                <!-- Action Buttons -->
                <button class="btn btn-pickup btn-full" id="pickupBtn" onclick="collectParcel()" disabled>
                    üîì Open Locker & Collect Parcel
                </button>
                
                <div style="margin-top: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="resendOTP()">
                        üì± Resend OTP Code
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearOTP()" style="margin-left: 10px;">
                        üóëÔ∏è Clear OTP
                    </button>
                </div>
            </div>

            <!-- Success Message (Hidden by default) -->
            <div class="success-animation" id="successMessage" style="display: none;">
                <div class="locker-opening">üîì</div>
                <h2 style="color: #28a745;">‚úÖ Parcel Collected Successfully!</h2>
                <p>Locker <strong id="successLocker">LKR-M02</strong> is now open.</p>
                <p>Please collect your parcel and close the locker door securely.</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showNewParcel()">
                        üì¶ Check for Another Parcel
                    </button>
                </div>
            </div>
        </div>

        <!-- Pickup History -->
        <div class="pickup-history">
            <h2>üìã Your Pickup History</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Locker</th>
                        <th>Sender</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="historyTable">
                    <tr>
                        <td>Yesterday, 2:30 PM</td>
                        <td>LKR-S01</td>
                        <td>Amazon</td>
                        <td><span class="status-badge status-picked">Picked Up</span></td>
                    </tr>
                    <tr>
                        <td>Nov 20, 2024</td>
                        <td>LKR-L01</td>
                        <td>AliExpress</td>
                        <td><span class="status-badge status-picked">Picked Up</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Customer-specific JavaScript
        let otpTimer;
        let timeLeft = 585; // 9 minutes 45 seconds for demo
        
        // Correct OTP for demo (in real system, this would come from database)
        const correctOTP = "123456";

        // When page loads
        document.addEventListener('DOMContentLoaded', function() {
            startOTPTimer();
            setupOTPInputs();
        });

        function setupOTPInputs() {
            const otpInputs = document.querySelectorAll('.otp-digit');
            
            // Add event listeners to all OTP inputs
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    checkOTPComplete();
                });
                
                input.addEventListener('keydown', function(e) {
                    // Allow backspace and delete
                    if (e.key === 'Backspace') {
                        if (this.value === '' && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    }
                });
            });
        }

        function moveToNext(current, nextIndex) {
            // Move to next input if current has value
            if (current.value.length === 1) {
                const nextInput = document.querySelector(`.otp-inputs input:nth-child(${nextIndex + 1})`);
                if (nextInput) {
                    nextInput.focus();
                }
            }
            
            checkOTPComplete();
        }

        function checkOTPComplete() {
            const otpInputs = document.querySelectorAll('.otp-digit');
            let otpValue = '';
            let allFilled = true;
            
            // Get OTP value and check if all filled
            otpInputs.forEach(input => {
                otpValue += input.value;
                if (input.value === '') {
                    allFilled = false;
                }
            });
            
            // Enable pickup button if OTP is complete
            const pickupBtn = document.getElementById('pickupBtn');
            pickupBtn.disabled = !allFilled;
            
            return otpValue;
        }

        function collectParcel() {
            const otpValue = checkOTPComplete();
            
            if (otpValue.length !== 6) {
                alert('Please enter a complete 6-digit OTP code.');
                return;
            }
            
            // Show loading
            const pickupBtn = document.getElementById('pickupBtn');
            pickupBtn.innerHTML = '‚è≥ Validating OTP...';
            pickupBtn.disabled = true;
            
            // Simulate OTP validation
            setTimeout(function() {
                if (otpValue === correctOTP) {
                    // OTP is correct - open locker
                    openLocker();
                } else {
                    // OTP is wrong
                    alert('‚ùå Invalid OTP code. Please check the code and try again.');
                    pickupBtn.innerHTML = 'üîì Open Locker & Collect Parcel';
                    pickupBtn.disabled = false;
                    clearOTP();
                }
            }, 1500);
        }

        function openLocker() {
            const lockerNumber = document.getElementById('lockerNumber').textContent;
            
            // Show success animation
            document.getElementById('pickupBtn').style.display = 'none';
            document.querySelector('.otp-input-section h3').style.display = 'none';
            document.querySelector('.otp-input-section p').style.display = 'none';
            document.querySelector('.otp-inputs').style.display = 'none';
            document.querySelector('.instruction-box').style.display = 'none';
            
            // Show success message
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('successLocker').textContent = lockerNumber;
            
            // Update parcel status
            document.getElementById('parcelStatus').textContent = 'Picked Up';
            document.getElementById('parcelStatus').className = 'status-badge status-picked';
            
            // Add to history
            addToPickupHistory(lockerNumber);
            
            // In real system, this would send signal to unlock physical locker
            console.log('Locker unlocked:', lockerNumber);
            console.log('Parcel collected by customer');
        }

        function addToPickupHistory(locker) {
            const table = document.getElementById('historyTable');
            const now = new Date();
            const dateString = now.toLocaleDateString() + ', ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const newRow = `
                <tr>
                    <td>${dateString}</td>
                    <td>${locker}</td>
                    <td>Jumia Kenya</td>
                    <td><span class="status-badge status-picked">Picked Up</span></td>
                </tr>
            `;
            
            table.innerHTML = newRow + table.innerHTML;
        }

        function resendOTP() {
            // Show loading
            const buttons = document.querySelectorAll('.btn-secondary');
            buttons[0].innerHTML = 'üì± Sending...';
            buttons[0].disabled = true;
            
            // Simulate SMS resend
            setTimeout(function() {
                alert('üì± New OTP code has been sent to your phone!');
                buttons[0].innerHTML = 'üì± Resend OTP Code';
                buttons[0].disabled = false;
                
                // Reset timer (in real system, generate new OTP)
                resetOTPTimer();
                
                console.log('New OTP sent to customer');
            }, 2000);
        }

        function clearOTP() {
            const otpInputs = document.querySelectorAll('.otp-digit');
            otpInputs.forEach(input => {
                input.value = '';
            });
            
            document.getElementById('pickupBtn').disabled = true;
            document.querySelector('.otp-digit').focus();
        }

        function startOTPTimer() {
            updateTimerDisplay();
            
            otpTimer = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(otpTimer);
                    document.getElementById('otpTimer').textContent = 'EXPIRED';
                    document.getElementById('otpTimer').style.color = '#e74c3c';
                    document.getElementById('pickupBtn').disabled = true;
                    alert('‚è∞ OTP has expired. Please request a new code.');
                } else if (timeLeft <= 60) {
                    // Less than 1 minute - turn red
                    document.getElementById('otpTimer').style.color = '#e74c3c';
                }
            }, 1000);
        }

        function resetOTPTimer() {
            clearInterval(otpTimer);
            timeLeft = 600; // Reset to 10 minutes
            document.getElementById('otpTimer').style.color = '#333';
            startOTPTimer();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('otpTimer').textContent = 
                minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        }

        function showNewParcel() {
            // Reset the page for demo purposes
            location.reload();
        }

        // Demo: Auto-fill OTP after 2 seconds for testing
        setTimeout(function() {
            if (confirm('For demo purposes, would you like to auto-fill the OTP? (123456)')) {
                const otpInputs = document.querySelectorAll('.otp-digit');
                const demoOTP = "123456";
                
                otpInputs.forEach((input, index) => {
                    input.value = demoOTP[index];
                });
                
                checkOTPComplete();
            }
        }, 2000);
    </script>
</body>
</html>

<script>
const API_BASE = 'http://localhost/vuma/backend/api';

// Validate OTP function
async function validateOTP(parcelId, otpCode) {
    try {
        const response = await fetch(`${API_BASE}/validate-otp.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                parcel_id: parcelId,
                otp_code: otpCode
            })
        });

        const data = await response.json();
        return data;
    } catch (error) {
        return { success: false, message: 'Network error' };
    }
}

// Update collect parcel function
async function collectParcel() {
    const otpInputs = document.querySelectorAll('.otp-digit');
    let otpValue = '';
    
    otpInputs.forEach(input => {
        otpValue += input.value;
    });
    
    if (otpValue.length !== 6) {
        alert('Please enter complete 6-digit OTP');
        return;
    }
    
    // For demo, use a sample parcel ID
    const parcelId = 1;
    
    const button = document.getElementById('pickupBtn');
    button.innerHTML = '‚è≥ Validating...';
    button.disabled = true;
    
    const result = await validateOTP(parcelId, otpValue);
    
    if (result.success) {
        // Show success
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('parcelStatus').textContent = 'Picked Up';
        document.getElementById('parcelStatus').className = 'status-badge status-picked';
        
        // Add to history
        addToPickupHistory('LKR-M01');
    } else {
        alert('‚ùå ' + result.message);
        button.innerHTML = 'üîì Open Locker & Collect Parcel';
        button.disabled = false;
        clearOTP();
    }
}

// Update the collectParcel function call in your existing code
</script>
